# API Contract

This document outlines the API endpoints for the Snacksy Video Suggester application.

## Endpoint: `/api/suggest_video`

*   **Method:** `POST`
*   **Description:** Accepts a food image, analyzes it using Google Gemini, and returns detected food-related tags. This endpoint is currently unprotected and does not require authentication.
*   **Request:**
    *   `Content-Type: multipart/form-data`
    *   Body should contain a single field:
        *   `file`: The image file to be analyzed.
*   **Response (Success):**
    *   `Content-Type: application/json`
    *   Body:
        ```json
        {
          "filename": "string",
          "content_type": "string",
          "detected_tags": ["string", "string"]
        }
        ```
    *   **Example (with Gemini-powered tags):**
        ```json
        {
          "filename": "spaghetti.jpg",
          "content_type": "image/jpeg",
          "detected_tags": ["spaghetti", "pasta", "tomato sauce", "comfort food"]
        }
        ```
*   **Error Responses:**
    *   **400 Bad Request:** If the uploaded file is invalid or not an image.
        ```json
        {
          "detail": "Invalid image file: <error reason>"
        }
        ```
    *   **500 Internal Server Error:** If an error occurs during Gemini processing or other server-side issues.
        ```json
        {
          "detail": "Error processing image with Gemini: <error reason>"
        }
        ```
*   **Note on Tag Generation:**
    The `detected_tags` are generated by Google's Gemini model. The quality and number of tags may vary based on the image content and model interpretation. If no relevant food items are detected or the image is ambiguous, the `detected_tags` array might be empty.

---

## Endpoint: `/auth/google/login`

*   **Method:** `POST`
*   **Description:** Handles the Google OAuth 2.0 authorization code received from the frontend. It exchanges this code for access and refresh tokens, verifies the user's identity, creates or updates the user in the database (storing encrypted tokens), and returns basic user information. Upon successful authentication, it also sets an HTTP-only session cookie.
*   **Request Body:**
    *   `Content-Type: application/json`
    *   Body:
        ```json
        {
          "code": "string" 
        }
        ```
        *   `code`: The authorization code obtained from Google after user consent on the frontend.
*   **Response (Success):**
    *   `Content-Type: application/json`
    *   Body:
        ```json
        {
          "message": "User authenticated successfully",
          "google_id": "string_google_user_id",
          "email": "user_email@example.com"
        }
        ```
    *   **Cookie Note**: Sets an HTTP-only cookie named `session_token` containing a JWT for session management. The cookie is configured with `HttpOnly`, `SameSite=Lax`, and `Secure` (in production environments).
*   **Error Responses:**
    *   **400 Bad Request:**
        *   If the authorization code is invalid or expired.
            ```json
            { "detail": "Failed to fetch token from Google: <error reason>" }
            ```
        *   If the ID token received from Google is invalid.
            ```json
            { "detail": "Invalid ID token: <error reason>" }
            ```
    *   **500 Internal Server Error:**
        *   If `client_secret.json` is missing or misconfigured.
            ```json
            { "detail": "client_secret.json not found. Please ensure it is present in the backend directory." }
            ```
        *   If `GOOGLE_REDIRECT_URI` is not configured.
            ```json
            { "detail": "GOOGLE_REDIRECT_URI is not configured on the server." }
            ```
        *   If JWT configuration is missing on the server.
            ```json
            { "detail": "JWT_SECRET_KEY is not configured on the server." }
            ```
        *   For other server-side issues (e.g., database errors, encryption errors, problems initializing Google Auth flow).
            ```json
            { "detail": "Database or encryption error: <error reason>" } 
            ```
            ```json
            { "detail": "Error initializing Google Auth flow: <error reason>" }
            ```
---

## Endpoint: `/auth/logout`

*   **Method:** `POST`
*   **Description:** Logs the user out by clearing their session cookie.
*   **Authentication**: Requires a valid `session_token` cookie to be sent, though the endpoint's primary function is to clear this token regardless of its prior validity if present.
*   **Request Body:** None.
*   **Success Response (200 OK):**
    *   `Content-Type: application/json`
    *   Body:
        ```json
        {
          "message": "Successfully logged out"
        }
        ```
    *   **Cookie Note**: Clears the `session_token` HTTP-only cookie.
*   **Error Responses:**
    *   Generally, this endpoint aims for a successful response even if the cookie was already absent. No specific error responses are typically defined beyond standard server errors (e.g., 500 if the server has an internal issue processing the request).

---

## Endpoint: `/api/youtube_activity`

*   **Method:** `GET`
*   **Description:** Fetches a list of the authenticated user's liked YouTube videos.
*   **Authentication:** Requires authentication via an HTTP-only `session_token` cookie containing a valid JWT.
*   **Query Parameters:** None. (User is identified from the session token).
*   **Success Response (200 OK):**
    *   `Content-Type: application/json`
    *   Body: A JSON array of video objects.
    *   **Example Video Object Structure**:
        ```json
        {
            "id": "VIDEO_ID_HERE",
            "title": "Example Video Title",
            "thumbnail": "http://example.com/thumbnail.jpg",
            "duration": "PT15M33S", 
            "viewCount": "1000000",
            "likeCount": "50000", 
            "channelTitle": "Example Channel"
        }
        ```
        *   *Note on `likeCount`*: For videos retrieved via `myRating='like'`, the `likeCount` in the statistics part usually refers to the public like count of the video, not a user-specific value.
    *   **Example Response (Array of videos)**:
        ```json
        [
            {
                "id": "VIDEO_ID_HERE_1",
                "title": "First Liked Video",
                "thumbnail": "http://example.com/thumb1.jpg",
                "duration": "PT5M0S",
                "viewCount": "12345",
                "likeCount": "678",
                "channelTitle": "Channel A"
            }
            // ... more videos
        ]
        ```
*   **Error Responses:**
    *   **401 Unauthorized**: If the `session_token` cookie is missing, invalid, or expired.
        ```json
        { "detail": "Not authenticated (no session token)" }
        ```
        ```json
        { "detail": "Invalid or expired token" }
        ```
        ```json
        { "detail": "Authentication token expired or invalid, and refresh failed: [Error details from Google]. Please re-authenticate." }
        ```
    *   **403 Forbidden**: If the YouTube API access is denied.
        ```json
        { "detail": "Access to YouTube API forbidden. Check API permissions or scopes: [Specific error details]" }
        ```
    *   **404 Not Found**: If the user's credentials (needed for YouTube API) are not found in the database.
        ```json
        { "detail": "User or credentials not found. Please authenticate." } 
        ```
    *   **500 Internal Server Error**: For other server-side issues.
        ```json
        { "detail": "Error fetching YouTube activity: [Specific error message]" }
        ```
---

## Endpoint: `/api/recommend_video`

*   **Method:** `POST`
*   **Description:** Fetches personalized YouTube video recommendations based on food tags and the user's YouTube activity. Uses Gemini AI for the recommendation logic.
*   **Authentication:** Requires authentication via an HTTP-only `session_token` cookie containing a valid JWT.
*   **Request Body:**
    *   `Content-Type: application/json`
    *   **Schema**:
        ```json
        {
          "food_tags": ["string"]
        }
        ```
        *   `food_tags`: List of food tags from image analysis.
    *   **Example**:
        ```json
        {
          "food_tags": ["pizza", "cheese", "pepperoni"]
        }
        ```
*   **Success Response (200 OK):**
    *   `Content-Type: application/json`
    *   Body: A JSON array of recommendation objects. Each object contains `video_id`, `title`, and `reason`.
        (Note: If Gemini couldn't find recommendations or if an error occurs during YouTube activity fetching (which is a soft failure), this could be an empty list `[]`).
    *   **Example Recommendation Object**:
        ```json
        {
            "video_id": "YOUTUBE_VIDEO_ID",
            "title": "Awesome Pizza Review Video",
            "reason": "This video matches your interest in pizza and aligns with your recently watched food review channels."
        }
        ```
    *   **Example Response (Array of recommendations)**:
        ```json
        [
            {
                "video_id": "dQw4w9WgXcQ",
                "title": "Funny Cat Video",
                "reason": "A lighthearted video that pairs well with casual snacking, similar to other funny content you've enjoyed."
            }
            // ... more recommendations
        ]
        ```
*   **Error Responses:**
    *   **400 Bad Request**: If `food_tags` is empty or missing.
        ```json
        { "detail": "Cannot generate recommendations without food tags if YouTube activity is also unavailable." }
        ```
    *   **401 Unauthorized**: If the `session_token` cookie is missing, invalid, or expired.
        ```json
        { "detail": "Not authenticated (no session token)" }
        ```
        ```json
        { "detail": "Invalid or expired token" }
        ```
    *   **500 Internal Server Error**: For issues with the Gemini API call or other unexpected server errors.
        ```json
        { "detail": "Failed to get recommendations from Gemini: [Specific error message]" }
        ```
---
